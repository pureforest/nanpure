<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ©ãƒ¼æ•°ç‹¬ - ç„¡æ–™ã§éŠã¹ã‚‹è‰²å½©ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ  | Color Sudoku</title>
    <meta name="description" content="æ•°å­—ã®ä»£ã‚ã‚Šã«9è‰²ã®ã‚«ãƒ©ãƒ¼ã‚’ä½¿ã†æ–°ã—ã„æ•°ç‹¬ï¼ˆãƒŠãƒ³ãƒ—ãƒ¬ï¼‰ãƒ‘ã‚ºãƒ«ã§ã™ã€‚é›£æ˜“åº¦é¸æŠã€ãƒã‚ªãƒ³ãƒ»è‰²é‰›ç­†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆã€ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½ã‚’æ­è¼‰ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»Šã™ãç„¡æ–™ã§éŠã¹ã¾ã™ã€‚">
    <meta name="keywords" content="ã‚«ãƒ©ãƒ¼æ•°ç‹¬,æ•°ç‹¬,ãƒŠãƒ³ãƒ—ãƒ¬,ç„¡æ–™ã‚²ãƒ¼ãƒ ,ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ ,ãƒ‘ã‚ºãƒ«,æš‡ã¤ã¶ã—,è„³ãƒˆãƒ¬">
    
    <!-- OGP (Open Graph Protocol) -->
    <meta property="og:title" content="ã‚«ãƒ©ãƒ¼æ•°ç‹¬ - ç„¡æ–™ã§éŠã¹ã‚‹è‰²å½©ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ ">
    <meta property="og:description" content="æ•°å­—ã‚’ä½¿ã‚ãªã„ç›´æ„Ÿçš„ãªè‰²ãƒ‘ã‚ºãƒ«ã€‚ã‚ãªãŸã®è‰²å½©æ„Ÿè¦šã‚’è©¦ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="ã‚«ãƒ©ãƒ¼æ•°ç‹¬ - ç„¡æ–™ã§éŠã¹ã‚‹è‰²å½©ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ ">
    <meta name="twitter:description" content="æ•°å­—ã‚’ä½¿ã‚ãªã„ç›´æ„Ÿçš„ãªè‰²ãƒ‘ã‚ºãƒ«ã€‚ã‚ãªãŸã®è‰²å½©æ„Ÿè¦šã‚’è©¦ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ">
    
    <!-- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "ã‚«ãƒ©ãƒ¼æ•°ç‹¬ (Color Sudoku)",
        "operatingSystem": "Web Browser",
        "applicationCategory": "GameApplication",
        "genre": "Puzzle",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "JPY"
        },
        "featureList": [
            "9è‰²ã®ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ—ã«ã‚ˆã‚‹æ•°ç‹¬",
            "3æ®µéšã®é›£æ˜“åº¦è¨­å®š",
            "ãƒã‚ªãƒ³ãƒ¢ãƒ¼ãƒ‰ã¨è‰²é‰›ç­†ãƒ¢ãƒ¼ãƒ‰",
            "å€™è£œæ›¸ãè¾¼ã¿æ©Ÿèƒ½",
            "ãƒ’ãƒ³ãƒˆãƒ»ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½"
        ]
    }
    </script>
    
    <!-- Google Fonts æœ€é©åŒ– -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ç”¨ã®éè¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        :root {
            --bg-dark: #0f0f1e;
            --bg-light: #1a1a2e;
            --text: #e8f0ff;
            --text-dim: #8b9dc3;
            --grid-line: #2d3350;
            --grid-thick: #4a5280;
            --cell-bg: #16213e;
            --cell-hover: #1e2d4f;
            --cell-selected: #2a3f6f;
            --border-glow: rgba(255, 255, 255, 0.1);
        }

        /* è‰²é‰›ç­†ãƒ¢ãƒ¼ãƒ‰ç”¨ã®æ˜ã‚‹ã„ã‚«ãƒ©ãƒ¼ */
        body.pencil-mode {
            --bg-dark: #fef9f3;
            --bg-light: #fff5eb;
            --text: #2c3e50;
            --text-dim: #5a6c7d;
            --grid-line: #d4c5b9;
            --grid-thick: #a89080;
            --cell-bg: #ffffff;
            --cell-hover: #fff8f0;
            --cell-selected: #ffe8d6;
            --border-glow: rgba(0, 0, 0, 0.05);
        }

        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒã‚ªãƒ³ï¼‰ã®9è‰² */
        .color-1 { background: linear-gradient(135deg, #ff8fab, #ff6b8a); } /* ãƒ”ãƒ³ã‚¯ */
        .color-2 { background: linear-gradient(135deg, #dc2626, #b91c1c); } /* æ¿ƒã„èµ¤ */
        .color-3 { background: linear-gradient(135deg, #fef08a, #fde047); } /* è–„ã„é»„è‰² */
        .color-4 { background: linear-gradient(135deg, #fb923c, #f97316); } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
        .color-5 { background: linear-gradient(135deg, #67e8f9, #22d3ee); } /* æ°´è‰² */
        .color-6 { background: linear-gradient(135deg, #3b82f6, #2563eb); } /* é’è‰² */
        .color-7 { background: linear-gradient(135deg, #a3e635, #84cc16); } /* é»„ç·‘ */
        .color-8 { background: linear-gradient(135deg, #22c55e, #16a34a); } /* ç·‘ */
        .color-9 { background: linear-gradient(135deg, #a855f7, #9333ea); } /* ç´« */

        /* è‰²é‰›ç­†ãƒ¢ãƒ¼ãƒ‰ç”¨ã®9è‰²ï¼ˆæŸ”ã‚‰ã‹ãæ˜ã‚‹ã„è‰²ï¼‰ */
        body.pencil-mode .color-1 { background: linear-gradient(135deg, #ffc0cb, #ffb6c1); } /* ãƒ”ãƒ³ã‚¯ */
        body.pencil-mode .color-2 { background: linear-gradient(135deg, #ef4444, #dc2626); } /* æ¿ƒã„èµ¤ */
        body.pencil-mode .color-3 { background: linear-gradient(135deg, #fef9c3, #fef08a); } /* è–„ã„é»„è‰² */
        body.pencil-mode .color-4 { background: linear-gradient(135deg, #fdba74, #fb923c); } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
        body.pencil-mode .color-5 { background: linear-gradient(135deg, #a5f3fc, #67e8f9); } /* æ°´è‰² */
        body.pencil-mode .color-6 { background: linear-gradient(135deg, #60a5fa, #3b82f6); } /* é’è‰² */
        body.pencil-mode .color-7 { background: linear-gradient(135deg, #bef264, #a3e635); } /* é»„ç·‘ */
        body.pencil-mode .color-8 { background: linear-gradient(135deg, #4ade80, #22c55e); } /* ç·‘ */
        body.pencil-mode .color-9 { background: linear-gradient(135deg, #c084fc, #a855f7); } /* ç´« */

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-light) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            width: 1000px;
            height: 1000px;
            background: radial-gradient(circle, rgba(255,107,107,0.15) 0%, transparent 70%);
            top: -500px;
            right: -500px;
            pointer-events: none;
            animation: colorPulse 10s ease-in-out infinite;
        }

        body.pencil-mode::before {
            background: radial-gradient(circle, rgba(255,182,193,0.2) 0%, transparent 70%);
        }

        body::after {
            content: '';
            position: absolute;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(78,205,196,0.1) 0%, transparent 70%);
            bottom: -400px;
            left: -400px;
            pointer-events: none;
            animation: colorPulse 12s ease-in-out infinite reverse;
        }

        body.pencil-mode::after {
            background: radial-gradient(circle, rgba(173,216,230,0.15) 0%, transparent 70%);
        }

        @keyframes colorPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .container {
            max-width: 700px;
            width: 100%;
            animation: fadeIn 0.8s ease-out;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #ffe66d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1rem;
            font-weight: 300;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .tagline {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 400;
        }

        .game-container {
            background: rgba(26, 26, 46, 0.7);
            backdrop-filter: blur(30px);
            border: 1px solid var(--grid-thick);
            border-radius: 24px;
            padding: 35px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);
        }

        .difficulty-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        /* é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã¨ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ã®ã‚°ãƒ«ãƒ¼ãƒ— */
        .difficulty-buttons-row,
        .mode-toggles-row {
            display: contents;
        }

        .mode-toggle {
            display: flex;
            gap: 8px;
            padding: 8px 16px;
            background: var(--cell-bg);
            border: 1px solid var(--grid-line);
            border-radius: 12px;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-toggle:hover {
            background: var(--cell-hover);
            border-color: rgba(78, 205, 196, 0.5);
        }

        .mode-toggle.active {
            background: linear-gradient(135deg, #4ecdc4, #44a6b5);
            border-color: #4ecdc4;
            box-shadow: 0 3px 15px rgba(78, 205, 196, 0.3);
        }

        .mode-toggle.active .mode-toggle-label {
            color: white;
        }

        .mode-toggle-icon {
            font-size: 1.2rem;
        }

        .mode-toggle-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .difficulty-btn {
            font-family: 'Outfit', sans-serif;
            padding: 10px 25px;
            border: 1px solid var(--grid-line);
            border-radius: 12px;
            background: var(--cell-bg);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .difficulty-btn:hover {
            background: var(--cell-hover);
            border-color: rgba(78, 205, 196, 0.5);
            transform: translateY(-2px);
        }

        .difficulty-btn.active {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border-color: #ff6b6b;
            color: white;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);
        }

        .grid-wrapper {
            position: relative;
            padding: 3px;
            background: var(--grid-thick);
            border-radius: 12px;
            margin: 25px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 1px;
            background: var(--grid-line);
            border-radius: 10px;
            overflow: hidden;
        }

        .cell {
            aspect-ratio: 1;
            background: var(--cell-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            font-weight: 600;
            font-size: 1.5rem;
        }

        .cell:hover {
            background: var(--cell-hover);
        }

        .cell.selected {
            background: var(--cell-selected);
            box-shadow: inset 0 0 0 2px rgba(78, 205, 196, 0.5);
        }

        .cell.given {
            cursor: default;
        }

        .cell.error {
            animation: shake 0.3s ease;
        }

        .cell.error .cell-color {
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.8);
        }

        .cell.error .cell-number {
            color: #ff6b6b;
        }

        .cell.correct .cell-color {
            animation: pulse 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        /* 3x3ãƒ–ãƒ­ãƒƒã‚¯ã®å¤ªã„ç½«ç·š */
        .cell:nth-child(3n) { border-right: 2px solid var(--grid-thick); }
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid var(--grid-thick);
        }

        .cell-color {
            width: 70%;
            height: 70%;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .cell-number {
            position: absolute;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        body.number-mode .cell-color {
            display: none;
        }

        body.number-mode .cell-number {
            display: block;
        }

        body:not(.number-mode) .cell-number {
            display: none;
        }

        /* å€™è£œãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .cell-candidates {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 90%;
            height: 90%;
            position: absolute;
            top: 5%;
            left: 5%;
        }

        .candidate-item {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.55rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .candidate-item.active {
            opacity: 1;
        }

        .candidate-item .candidate-color {
            width: 60%;
            height: 60%;
            border-radius: 3px;
        }

        .candidate-item .candidate-number {
            display: none;
            font-size: 0.6rem;
            color: var(--text-dim);
        }

        body.number-mode .candidate-item .candidate-color {
            display: none;
        }

        body.number-mode .candidate-item .candidate-number {
            display: block;
        }

        .color-palette {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .palette-btn {
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .palette-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .palette-btn.clear {
            background: var(--cell-bg);
            border: 2px solid var(--grid-line);
            color: var(--text-dim);
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ãƒ‘ãƒ¬ãƒƒãƒˆãƒœã‚¿ãƒ³ã®æ•°å­—è¡¨ç¤º */
        .palette-number {
            display: none;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* æ•°å­—ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ‘ãƒ¬ãƒƒãƒˆ */
        body.number-mode .palette-btn:not(.clear) {
            background: var(--cell-bg) !important;
            border: 2px solid var(--grid-line);
        }

        body.number-mode .palette-btn:not(.clear) .palette-number {
            display: block;
        }

        body.number-mode .palette-btn:not(.clear):hover {
            background: var(--cell-hover) !important;
            border-color: rgba(78, 205, 196, 0.5);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            font-family: 'Outfit', sans-serif;
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            background: var(--cell-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid var(--grid-line);
        }

        .control-btn:hover {
            background: var(--cell-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn.new-game {
            background: linear-gradient(135deg, #4ecdc4, #44a6b5);
            border: none;
        }

        .control-btn.new-game:hover {
            background: linear-gradient(135deg, #5ed9d0, #52b4c3);
        }

        .timer {
            text-align: center;
            font-size: 2rem;
            font-weight: 300;
            color: var(--text-dim);
            margin-top: 20px;
            font-variant-numeric: tabular-nums;
        }

        .difficulty-info {
            text-align: center;
            margin-top: 15px;
            padding: 15px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        .difficulty-info h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .difficulty-info p {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.6;
            margin-bottom: 5px;
        }

        .difficulty-info .note {
            font-size: 0.75rem;
            color: var(--text-dim);
            font-style: italic;
            margin-top: 8px;
            opacity: 0.8;
        }

        body.pencil-mode .difficulty-info {
            background: rgba(78, 205, 196, 0.08);
            border-color: rgba(78, 205, 196, 0.15);
        }

        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(20px);
            padding: 50px 70px;
            border-radius: 24px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s ease;
            border: 1px solid var(--grid-thick);
            z-index: 1000;
        }

        .message.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .message h2 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .message p {
            color: var(--text-dim);
            font-size: 1.1rem;
        }

        /* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .confirm-dialog.show {
            opacity: 1;
            pointer-events: auto;
        }

        .confirm-content {
            background: rgba(26, 26, 46, 0.98);
            backdrop-filter: blur(20px);
            padding: 35px 45px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid var(--grid-thick);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            transition: transform 0.3s ease;
            max-width: 400px;
            width: 90%;
        }

        .confirm-dialog.show .confirm-content {
            transform: scale(1);
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .confirm-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
        }

        .confirm-message {
            color: var(--text-dim);
            font-size: 1rem;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            font-family: 'Outfit', sans-serif;
            padding: 12px 35px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .confirm-btn.cancel {
            background: var(--cell-bg);
            color: var(--text-dim);
            border: 1px solid var(--grid-line);
        }

        .confirm-btn.cancel:hover {
            background: var(--cell-hover);
            border-color: rgba(78, 205, 196, 0.5);
        }

        .confirm-btn.ok {
            background: linear-gradient(135deg, #4ecdc4, #44a6b5);
            color: white;
        }

        .confirm-btn.ok:hover {
            background: linear-gradient(135deg, #5ed9d0, #52b4c3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .confirm-btn.hint {
            background: linear-gradient(135deg, #ffd93d, #f4a300);
            color: #333;
        }

        .confirm-btn.hint:hover {
            background: linear-gradient(135deg, #ffe066, #f5b800);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 217, 61, 0.3);
        }

        body.pencil-mode .confirm-dialog {
            background: rgba(0, 0, 0, 0.5);
        }

        body.pencil-mode .confirm-content {
            background: rgba(255, 255, 255, 0.98);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 15, 30, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading.show {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--grid-line);
            border-top-color: #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading p {
            margin-top: 20px;
            color: var(--text-dim);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            max-width: 300px;
            z-index: 9999;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ (481px - 768px) */
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 0 10px;
            }

            h1 { font-size: 2.8rem; }
            
            .game-container { 
                padding: 25px; 
                border-radius: 20px;
            }

            .difficulty-selector {
                gap: 8px;
            }

            .difficulty-btn {
                padding: 8px 18px;
                font-size: 0.85rem;
            }

            .mode-toggle {
                padding: 6px 12px;
            }

            .mode-toggle-label {
                font-size: 0.75rem;
            }

            .cell { font-size: 1.3rem; }
            
            .palette-btn { 
                width: 38px; 
                height: 38px; 
            }
            
            .control-btn { 
                padding: 10px 22px; 
                font-size: 0.9rem; 
            }

            .timer {
                font-size: 1.8rem;
            }
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ (max-width: 480px) */
        @media (max-width: 480px) {
            body {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            header {
                margin-bottom: 20px;
            }

            h1 { 
                font-size: 2rem; 
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 0.85rem;
                letter-spacing: 0.1em;
            }

            .tagline {
                font-size: 0.75rem;
                margin-top: 5px;
            }
            
            .game-container { 
                padding: 15px; 
                border-radius: 16px;
            }

            /* é›£æ˜“åº¦ã¨ãƒ¢ãƒ¼ãƒ‰ã‚’2è¡Œã«åˆ†ã‘ã‚‹ */
            .difficulty-selector {
                flex-direction: column;
                gap: 10px;
            }

            .difficulty-selector > .difficulty-btn,
            .difficulty-selector > .mode-toggle {
                flex: none;
            }

            /* é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ– */
            .difficulty-buttons-row {
                display: flex;
                gap: 8px;
                justify-content: center;
                width: 100%;
            }

            .difficulty-btn {
                padding: 10px 20px;
                font-size: 0.85rem;
                flex: 1;
                max-width: 100px;
            }

            /* ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ– */
            .mode-toggles-row {
                display: flex;
                gap: 6px;
                justify-content: center;
                width: 100%;
            }

            .mode-toggle {
                padding: 8px 10px;
                flex: 1;
                justify-content: center;
            }

            .mode-toggle-icon {
                font-size: 1rem;
            }

            .mode-toggle-label {
                font-size: 0.7rem;
            }

            /* ã‚°ãƒªãƒƒãƒ‰ */
            .grid-wrapper {
                margin: 15px 0;
            }

            .cell { 
                font-size: 1.1rem; 
            }

            .cell-color {
                width: 65%;
                height: 65%;
                border-radius: 6px;
            }

            .cell-number {
                font-size: 1.2rem;
            }

            /* å€™è£œè¡¨ç¤º */
            .candidate-item .candidate-color {
                border-radius: 2px;
            }

            .candidate-item .candidate-number {
                font-size: 0.5rem;
            }

            /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ - ã‚¿ãƒƒãƒ—ã—ã‚„ã™ãå¤§ããã€2è¡Œã« */
            .color-palette {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
                margin: 15px 0;
                max-width: 280px;
                margin-left: auto;
                margin-right: auto;
            }

            .palette-btn { 
                width: 100%;
                aspect-ratio: 1;
                max-width: 50px;
                max-height: 50px;
                border-radius: 10px;
                justify-self: center;
            }

            .palette-number {
                font-size: 1.1rem;
            }

            /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ - ç¸¦ä¸¦ã³ */
            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .control-btn { 
                padding: 14px 30px; 
                font-size: 1rem;
                width: 100%;
                border-radius: 10px;
            }

            .timer {
                font-size: 1.5rem;
                margin-top: 15px;
            }

            /* å®Œæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
            .message {
                padding: 30px 40px;
                border-radius: 16px;
            }

            .message h2 {
                font-size: 1.8rem;
            }

            .message p {
                font-size: 1rem;
            }

            /* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
            .confirm-content { 
                padding: 25px 20px;
                border-radius: 16px;
            }

            .confirm-icon {
                font-size: 2.5rem;
            }

            .confirm-title {
                font-size: 1.3rem;
            }

            .confirm-message {
                font-size: 0.9rem;
                margin-bottom: 20px;
            }

            .confirm-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .confirm-btn { 
                padding: 12px 30px;
                width: 100%;
            }
        }

        /* éå¸¸ã«å°ã•ã„ç”»é¢ (max-width: 360px) */
        @media (max-width: 360px) {
            h1 { font-size: 1.7rem; }

            .game-container { 
                padding: 12px; 
            }

            .difficulty-btn {
                padding: 8px 12px;
                font-size: 0.75rem;
            }

            .mode-toggle {
                padding: 6px 8px;
            }

            .mode-toggle-label {
                font-size: 0.65rem;
            }

            .color-palette {
                max-width: 240px;
                gap: 8px;
            }

            .palette-btn { 
                max-width: 42px;
                max-height: 42px;
            }

            .cell-number {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- SEOç”¨éè¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³å‘ã‘ï¼‰ -->
    <div style="display:none;">
        <h2>ã‚«ãƒ©ãƒ¼æ•°ç‹¬ï¼ˆColor Sudokuï¼‰- ç„¡æ–™ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </h2>
        <p>æ•°å­—ã®ä»£ã‚ã‚Šã«è‰²ã‚’ä½¿ã£ã¦è§£ãã€æ–°ã—ã„æ„Ÿè¦šã®æ•°ç‹¬ãƒ‘ã‚ºãƒ«ã€‚è„³ãƒˆãƒ¬ã‚„æš‡ã¤ã¶ã—ã«æœ€é©ã€‚ãƒã‚ªãƒ³ãƒ¢ãƒ¼ãƒ‰ã¨è‰²é‰›ç­†ãƒ¢ãƒ¼ãƒ‰ã‚’æ­è¼‰ã—ã¦ã„ã¾ã™ã€‚</p>
    </div>

    <main class="container">
        <header role="banner">
            <h1>ã‚«ãƒ©ãƒ¼æ•°ç‹¬</h1>
            <p class="subtitle">Color Sudoku</p>
            <p class="tagline">æ•°å­—ã®ä»£ã‚ã‚Šã«è‰²ã‚’ä½¿ã£ãŸç›´æ„Ÿçš„ãªè„³ãƒˆãƒ¬ãƒ‘ã‚ºãƒ«</p>
        </header>

        <article class="game-container">
            <h2 class="visually-hidden">ã‚²ãƒ¼ãƒ ç”»é¢</h2>
            <div class="difficulty-selector">
                <div class="difficulty-buttons-row">
                    <button class="difficulty-btn active" data-difficulty="easy">Easy</button>
                    <button class="difficulty-btn" data-difficulty="medium">Medium</button>
                    <button class="difficulty-btn" data-difficulty="hard">Hard</button>
                </div>
                <div class="mode-toggles-row">
                    <div class="mode-toggle" id="modeToggle" role="button" aria-label="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
                        <span class="mode-toggle-icon" aria-hidden="true">ğŸ¨</span>
                        <span class="mode-toggle-label">ãƒã‚ªãƒ³</span>
                    </div>
                    <div class="mode-toggle" id="displayModeToggle" role="button" aria-label="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">
                        <span class="mode-toggle-icon" aria-hidden="true">ğŸ¨</span>
                        <span class="mode-toggle-label">è‰²</span>
                    </div>
                    <div class="mode-toggle" id="candidateToggle" role="button" aria-label="å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">
                        <span class="mode-toggle-icon" aria-hidden="true">âœï¸</span>
                        <span class="mode-toggle-label">å€™è£œ</span>
                    </div>
                </div>
            </div>

            <div class="grid-wrapper">
                <div class="grid" id="grid"></div>
            </div>

            <div class="color-palette" id="colorPalette">
                <button class="palette-btn color-1" data-color="1"><span class="palette-number">1</span></button>
                <button class="palette-btn color-2" data-color="2"><span class="palette-number">2</span></button>
                <button class="palette-btn color-3" data-color="3"><span class="palette-number">3</span></button>
                <button class="palette-btn color-4" data-color="4"><span class="palette-number">4</span></button>
                <button class="palette-btn color-5" data-color="5"><span class="palette-number">5</span></button>
                <button class="palette-btn color-6" data-color="6"><span class="palette-number">6</span></button>
                <button class="palette-btn color-7" data-color="7"><span class="palette-number">7</span></button>
                <button class="palette-btn color-8" data-color="8"><span class="palette-number">8</span></button>
                <button class="palette-btn color-9" data-color="9"><span class="palette-number">9</span></button>
                <button class="palette-btn clear" data-color="0">Ã—</button>
            </div>

            <div class="controls">
                <button class="control-btn" id="checkBtn">ãƒã‚§ãƒƒã‚¯</button>
                <button class="control-btn" id="hintBtn">ãƒ’ãƒ³ãƒˆ</button>
                <button class="control-btn new-game" id="newGameBtn">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
            </div>

            <div class="timer" id="timer">00:00</div>

            <div class="difficulty-info">
                <h3>é›£æ˜“åº¦ã«ã¤ã„ã¦</h3>
                <p><strong>åˆç´š (Easy)</strong>: 35å€‹ã®ç©ºæ¬„ - åŸºæœ¬çš„ãªæ¨ç†ã§è§£ã‘ã¾ã™</p>
                <p><strong>ä¸­ç´š (Medium)</strong>: 45å€‹ã®ç©ºæ¬„ - ãƒšã‚¢æ¢ã—ã‚„æ¶ˆå»æ³•ãŒå¿…è¦ã§ã™</p>
                <p><strong>ä¸Šç´š (Hard)</strong>: 55å€‹ã®ç©ºæ¬„ - é«˜åº¦ãªè«–ç†çš„æ¨ç†ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™</p>
                <p class="note">â€» ç©ºæ¬„æ•°ãŒå¤šã„ã»ã©é«˜åº¦ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒå¿…è¦ã«ãªã‚‹ç¢ºç‡ãŒé«˜ã¾ã‚Šã¾ã™ãŒã€</br>
                ãƒ‘ã‚ºãƒ«ã®é…ç½®ã«ã‚ˆã£ã¦å®Ÿéš›ã®é›£æ˜“åº¦ã¯å¤‰å‹•ã—ã¾ã™</p>
            </div>
        </article>
    </main>

    <div class="message" id="message">
        <h2>ğŸ¨ å®Œæˆï¼</h2>
        <p>ç´ æ™´ã‚‰ã—ã„è‰²å½©æ„Ÿè¦šã§ã™ï¼</p>
    </div>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>å•é¡Œã‚’ç”Ÿæˆä¸­...</p>
    </div>

    <!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon" id="confirmIcon">ğŸ®</div>
            <div class="confirm-title" id="confirmTitle">ç¢ºèª</div>
            <div class="confirm-message" id="confirmMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" id="confirmCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="confirm-btn ok" id="confirmOk">OK</button>
            </div>
        </div>
    </div>

    <div class="debug-info" id="debugInfo"></div>

    <script>
        // ============================================================
        // æ”¹è‰¯ã•ã‚ŒãŸæ•°ç‹¬ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        // å‚è€ƒ: https://blog.dnpp.org/number_place_algorithm
        // ============================================================

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆURLã«?debug=1ã‚’ä»˜ã‘ã‚‹ã¨æœ‰åŠ¹ï¼‰
        const DEBUG = new URLSearchParams(window.location.search).has('debug');

        function debugLog(msg) {
            if (DEBUG) {
                console.log(msg);
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.classList.add('show');
                debugInfo.innerHTML = msg.replace(/\n/g, '<br>');
            }
        }

        // é–¢é€£ã™ã‚‹ãƒã‚¹ã®åº§æ¨™ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆé«˜é€ŸåŒ–ã®ãŸã‚ï¼‰
        const relatedPositionsCache = [];
        for (let row = 0; row < 9; row++) {
            relatedPositionsCache[row] = [];
            for (let col = 0; col < 9; col++) {
                const positions = [];
                // åŒã˜è¡Œ
                for (let c = 0; c < 9; c++) {
                    if (c !== col) positions.push([row, c]);
                }
                // åŒã˜åˆ—
                for (let r = 0; r < 9; r++) {
                    if (r !== row) positions.push([r, col]);
                }
                // åŒã˜3x3ãƒ–ãƒ­ãƒƒã‚¯
                const blockRow = Math.floor(row / 3) * 3;
                const blockCol = Math.floor(col / 3) * 3;
                for (let r = blockRow; r < blockRow + 3; r++) {
                    for (let c = blockCol; c < blockCol + 3; c++) {
                        if (r !== row || c !== col) {
                            // é‡è¤‡ã‚’é¿ã‘ã‚‹
                            const exists = positions.some(p => p[0] === r && p[1] === c);
                            if (!exists) positions.push([r, c]);
                        }
                    }
                }
                relatedPositionsCache[row][col] = positions;
            }
        }

        // å®Œå…¨ãªè§£ç­”ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
        function generateSolution() {
            const grid = Array(9).fill(null).map(() => Array(9).fill(0));
            
            function isValid(grid, row, col, num) {
                for (const [r, c] of relatedPositionsCache[row][col]) {
                    if (grid[r][c] === num) return false;
                }
                return true;
            }
            
            function solve(grid, pos = 0) {
                if (pos === 81) return true;
                
                const row = Math.floor(pos / 9);
                const col = pos % 9;
                
                // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãŸæ•°å­—ã®é…åˆ—
                const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5);
                
                for (const num of nums) {
                    if (isValid(grid, row, col, num)) {
                        grid[row][col] = num;
                        if (solve(grid, pos + 1)) return true;
                        grid[row][col] = 0;
                    }
                }
                return false;
            }
            
            solve(grid);
            return grid;
        }

        // è§£ãŒä¸€æ„ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        function hasUniqueSolution(puzzle) {
            const grid = puzzle.map(row => [...row]);
            let solutions = 0;
            
            function isValid(grid, row, col, num) {
                for (const [r, c] of relatedPositionsCache[row][col]) {
                    if (grid[r][c] === num) return false;
                }
                return true;
            }
            
            function countSolutions(grid, pos = 0) {
                if (solutions > 1) return;
                if (pos === 81) {
                    solutions++;
                    return;
                }
                
                const row = Math.floor(pos / 9);
                const col = pos % 9;
                
                if (grid[row][col] !== 0) {
                    countSolutions(grid, pos + 1);
                    return;
                }
                
                for (let num = 1; num <= 9; num++) {
                    if (isValid(grid, row, col, num)) {
                        grid[row][col] = num;
                        countSolutions(grid, pos + 1);
                        grid[row][col] = 0;
                    }
                }
            }
            
            countSolutions(grid);
            return solutions === 1;
        }

        // ãƒ‘ã‚ºãƒ«ã‚’ç”Ÿæˆï¼ˆãƒã‚¹ã‚’å–ã‚Šé™¤ãï¼‰
        function generatePuzzle(solution, difficulty) {
            const puzzle = solution.map(row => [...row]);
            
            const targetEmpty = {
                'easy': 35,
                'medium': 45,
                'hard': 55
            }[difficulty];
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªé †åºã§ãƒã‚¹ã‚’å‡¦ç†
            const positions = [];
            for (let i = 0; i < 81; i++) positions.push(i);
            positions.sort(() => Math.random() - 0.5);
            
            let removed = 0;
            const maxIterations = 81;
            let iterations = 0;
            
            for (const pos of positions) {
                if (removed >= targetEmpty || iterations >= maxIterations) break;
                iterations++;
                
                const row = Math.floor(pos / 9);
                const col = pos % 9;
                
                if (puzzle[row][col] === 0) continue;
                
                const backup = puzzle[row][col];
                puzzle[row][col] = 0;
                
                // ä¸€æ„æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå…¨é›£æ˜“åº¦ã§å®Ÿæ–½ï¼‰
                if (hasUniqueSolution(puzzle)) {
                    removed++;
                } else {
                    puzzle[row][col] = backup;
                }
            }
            
            debugLog(`Generated puzzle: ${removed} empty cells`);
            return puzzle;
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let currentSolution = null;
        let currentPuzzle = null;
        let originalPuzzle = null;
        let selectedCell = null;
        let difficulty = 'easy';
        let timerInterval = null;
        let startTime = null;
        let isPencilMode = false;
        let isNumberMode = false;
        let isCandidateMode = false;
        let currentCandidates = [];

        // å€™è£œãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
        function initCandidates() {
            currentCandidates = Array(9).fill(null).map(() => 
                Array(9).fill(null).map(() => new Set())
            );
        }

        // ã‚°ãƒªãƒƒãƒ‰ã‚’åˆæœŸåŒ–
        function initGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 81; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                
                // ã‚»ãƒ«ã®è‰²è¡¨ç¤ºç”¨
                const colorDiv = document.createElement('div');
                colorDiv.className = 'cell-color';
                cell.appendChild(colorDiv);
                
                // ã‚»ãƒ«ã®æ•°å­—è¡¨ç¤ºç”¨
                const numberDiv = document.createElement('div');
                numberDiv.className = 'cell-number';
                cell.appendChild(numberDiv);
                
                // å€™è£œè¡¨ç¤ºç”¨
                const candidatesDiv = document.createElement('div');
                candidatesDiv.className = 'cell-candidates';
                for (let n = 1; n <= 9; n++) {
                    const candidateItem = document.createElement('div');
                    candidateItem.className = 'candidate-item';
                    candidateItem.dataset.num = n;
                    
                    const candColor = document.createElement('div');
                    candColor.className = `candidate-color color-${n}`;
                    candidateItem.appendChild(candColor);
                    
                    const candNumber = document.createElement('div');
                    candNumber.className = 'candidate-number';
                    candNumber.textContent = n;
                    candidateItem.appendChild(candNumber);
                    
                    candidatesDiv.appendChild(candidateItem);
                }
                cell.appendChild(candidatesDiv);
                
                cell.addEventListener('click', () => selectCell(i));
                grid.appendChild(cell);
            }
        }

        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        function showConfirmDialog(icon, title, message, okText, okClass, onConfirm) {
            const dialog = document.getElementById('confirmDialog');
            const iconEl = document.getElementById('confirmIcon');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const okBtn = document.getElementById('confirmOk');
            const cancelBtn = document.getElementById('confirmCancel');

            iconEl.textContent = icon;
            titleEl.textContent = title;
            messageEl.textContent = message;
            okBtn.textContent = okText;
            okBtn.className = 'confirm-btn ' + okClass;

            dialog.classList.add('show');

            // å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã«ã‚¯ãƒ­ãƒ¼ãƒ³
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            // æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            newOkBtn.addEventListener('click', () => {
                dialog.classList.remove('show');
                onConfirm();
            });

            newCancelBtn.addEventListener('click', () => {
                dialog.classList.remove('show');
            });

            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    dialog.classList.remove('show');
                }
            });
        }

        // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ï¼ˆç¢ºèªä»˜ãï¼‰
        function confirmNewGame(newDifficulty = null) {
            // æœ€åˆã®ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ï¼ˆoriginalPuzzleãŒãªã„å ´åˆï¼‰ã¯ç¢ºèªä¸è¦
            if (!originalPuzzle) {
                if (newDifficulty) {
                    difficulty = newDifficulty;
                }
                startNewGame();
                return;
            }

            showConfirmDialog(
                'ğŸ®',
                'æ–°ã—ã„ã‚²ãƒ¼ãƒ ',
                'ç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™ã€‚\næ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ',
                'å§‹ã‚ã‚‹',
                'ok',
                () => {
                    if (newDifficulty) {
                        difficulty = newDifficulty;
                    }
                    startNewGame();
                }
            );
        }

        // ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºï¼ˆç¢ºèªä»˜ãï¼‰
        function confirmHint() {
            showConfirmDialog(
                'ğŸ’¡',
                'ãƒ’ãƒ³ãƒˆã‚’ä½¿ç”¨',
                'ãƒ©ãƒ³ãƒ€ãƒ ãªãƒã‚¹ã®ç­”ãˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚\nãƒ’ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã‹ï¼Ÿ',
                'ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹',
                'hint',
                () => {
                    showHint();
                }
            );
        }

        // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
        function startNewGame() {
            document.getElementById('message').classList.remove('show');
            document.getElementById('loading').classList.add('show');
            
            // UIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã«éåŒæœŸã§ç”Ÿæˆ
            setTimeout(() => {
                try {
                    currentSolution = generateSolution();
                    currentPuzzle = generatePuzzle(currentSolution, difficulty);
                    originalPuzzle = currentPuzzle.map(row => [...row]);
                    initCandidates();
                    renderGrid();
                    startTimer();
                } catch (e) {
                    console.error('Generation error:', e);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‘ã‚ºãƒ«ã‚’ç”Ÿæˆ
                    currentSolution = generateSolution();
                    currentPuzzle = currentSolution.map(row => [...row]);
                    // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒã‚¹ã‚’ç©ºã‘ã‚‹
                    const empty = difficulty === 'easy' ? 35 : difficulty === 'medium' ? 45 : 55;
                    let count = 0;
                    while (count < empty) {
                        const r = Math.floor(Math.random() * 9);
                        const c = Math.floor(Math.random() * 9);
                        if (currentPuzzle[r][c] !== 0) {
                            currentPuzzle[r][c] = 0;
                            count++;
                        }
                    }
                    originalPuzzle = currentPuzzle.map(row => [...row]);
                    initCandidates();
                    renderGrid();
                    startTimer();
                }
                
                document.getElementById('loading').classList.remove('show');
            }, 100);
        }

        // ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
        function renderGrid() {
            const cells = document.querySelectorAll('.cell');
            
            cells.forEach((cell, index) => {
                const row = Math.floor(index / 9);
                const col = index % 9;
                const value = currentPuzzle[row][col];
                const isGiven = originalPuzzle[row][col] !== 0;
                
                const colorDiv = cell.querySelector('.cell-color');
                const numberDiv = cell.querySelector('.cell-number');
                const candidatesDiv = cell.querySelector('.cell-candidates');
                
                // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                colorDiv.className = 'cell-color';
                cell.classList.remove('given');
                
                if (value !== 0) {
                    colorDiv.classList.add(`color-${value}`);
                    numberDiv.textContent = value;
                    candidatesDiv.style.display = 'none';
                    if (isGiven) {
                        cell.classList.add('given');
                    }
                } else {
                    numberDiv.textContent = '';
                    candidatesDiv.style.display = 'grid';
                    
                    // å€™è£œã‚’è¡¨ç¤º
                    const candidates = currentCandidates[row][col];
                    candidatesDiv.querySelectorAll('.candidate-item').forEach(item => {
                        const num = parseInt(item.dataset.num);
                        if (candidates.has(num)) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });
                }
            });
        }

        // ã‚»ãƒ«ã‚’é¸æŠ
        function selectCell(index) {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => c.classList.remove('selected'));
            
            const row = Math.floor(index / 9);
            const col = index % 9;
            
            if (originalPuzzle[row][col] !== 0) {
                selectedCell = null;
                return;
            }
            
            selectedCell = index;
            cells[index].classList.add('selected');
        }

        // è‰²ã‚’å…¥åŠ›
        function inputColor(color) {
            if (selectedCell === null) return;
            
            const row = Math.floor(selectedCell / 9);
            const col = selectedCell % 9;
            
            if (originalPuzzle[row][col] !== 0) return;
            
            const cell = document.querySelectorAll('.cell')[selectedCell];
            
            if (isCandidateMode && color !== 0) {
                // å€™è£œãƒ¢ãƒ¼ãƒ‰ï¼šå€™è£œã®ãƒˆã‚°ãƒ«
                if (currentCandidates[row][col].has(color)) {
                    currentCandidates[row][col].delete(color);
                } else {
                    currentCandidates[row][col].add(color);
                }
                // ç¢ºå®šå€¤ã‚’ã‚¯ãƒªã‚¢
                currentPuzzle[row][col] = 0;
            } else {
                // ç¢ºå®šãƒ¢ãƒ¼ãƒ‰
                currentPuzzle[row][col] = color;
                // å€™è£œã‚’ã‚¯ãƒªã‚¢
                currentCandidates[row][col].clear();
            }
            
            cell.classList.remove('error');
            renderGrid();
            checkCompletion();
        }

        // é–“é•ã„ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ­£è§£ã¨æ¯”è¼ƒï¼‰
        function checkErrors() {
            const cells = document.querySelectorAll('.cell');
            let hasError = false;
            
            cells.forEach(c => c.classList.remove('error'));
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const value = currentPuzzle[row][col];
                    // ç©ºã®ã‚»ãƒ«ã¨åˆæœŸé…ç½®ã®ã‚»ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (value === 0 || originalPuzzle[row][col] !== 0) continue;
                    
                    // æ­£è§£ã¨æ¯”è¼ƒ
                    if (value !== currentSolution[row][col]) {
                        cells[row * 9 + col].classList.add('error');
                        hasError = true;
                    }
                }
            }
            
            return hasError;
        }

        // å®Œæˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkCompletion() {
            let isComplete = true;
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (currentPuzzle[row][col] === 0) {
                        isComplete = false;
                        break;
                    }
                }
                if (!isComplete) break;
            }
            
            if (isComplete && !checkErrors()) {
                stopTimer();
                setTimeout(() => {
                    document.getElementById('message').classList.add('show');
                }, 400);
            }
        }

        // ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
        function showHint() {
            const emptyCells = [];
            
            for (let i = 0; i < 81; i++) {
                const row = Math.floor(i / 9);
                const col = i % 9;
                if (currentPuzzle[row][col] === 0) {
                    emptyCells.push(i);
                }
            }
            
            if (emptyCells.length === 0) return;
            
            const randomIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            const row = Math.floor(randomIndex / 9);
            const col = randomIndex % 9;
            const color = currentSolution[row][col];
            
            currentPuzzle[row][col] = color;
            currentCandidates[row][col].clear();
            
            const cells = document.querySelectorAll('.cell');
            cells[randomIndex].classList.add('correct');
            
            renderGrid();
            checkCompletion();
        }

        // ã‚¿ã‚¤ãƒãƒ¼
        function startTimer() {
            stopTimer();
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${minutes}:${seconds}`;
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›
        document.addEventListener('keydown', (e) => {
            if (e.key >= '1' && e.key <= '9') {
                inputColor(parseInt(e.key));
            } else if (e.key === '0' || e.key === 'Backspace' || e.key === 'Delete') {
                inputColor(0);
            }
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const newDiff = btn.dataset.difficulty;
                if (newDiff === difficulty && originalPuzzle) {
                    // åŒã˜é›£æ˜“åº¦ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã‚‚ç¢ºèªã‚’è¡¨ç¤º
                    confirmNewGame(newDiff);
                } else {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    confirmNewGame(newDiff);
                }
            });
        });

        document.querySelectorAll('.palette-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const color = parseInt(btn.dataset.color);
                inputColor(color);
            });
        });

        document.getElementById('newGameBtn').addEventListener('click', () => {
            confirmNewGame();
        });

        document.getElementById('checkBtn').addEventListener('click', checkErrors);
        document.getElementById('hintBtn').addEventListener('click', confirmHint);

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('modeToggle').addEventListener('click', () => {
            isPencilMode = !isPencilMode;
            const body = document.body;
            const modeLabel = document.querySelector('#modeToggle .mode-toggle-label');
            const modeIcon = document.querySelector('#modeToggle .mode-toggle-icon');
            const modeToggle = document.getElementById('modeToggle');
            
            if (isPencilMode) {
                body.classList.add('pencil-mode');
                modeLabel.textContent = 'è‰²é‰›ç­†';
                modeIcon.textContent = 'âœï¸';
                modeToggle.classList.add('active');
            } else {
                body.classList.remove('pencil-mode');
                modeLabel.textContent = 'ãƒã‚ªãƒ³';
                modeIcon.textContent = 'ğŸ¨';
                modeToggle.classList.remove('active');
            }
        });

        document.getElementById('displayModeToggle').addEventListener('click', () => {
            isNumberMode = !isNumberMode;
            const body = document.body;
            const displayModeToggle = document.getElementById('displayModeToggle');
            const modeLabel = displayModeToggle.querySelector('.mode-toggle-label');
            const modeIcon = displayModeToggle.querySelector('.mode-toggle-icon');
            
            if (isNumberMode) {
                body.classList.add('number-mode');
                modeLabel.textContent = 'æ•°å­—';
                modeIcon.textContent = 'ğŸ”¢';
                displayModeToggle.classList.add('active');
            } else {
                body.classList.remove('number-mode');
                modeLabel.textContent = 'è‰²';
                modeIcon.textContent = 'ğŸ¨';
                displayModeToggle.classList.remove('active');
            }
            
            renderGrid();
        });

        document.getElementById('candidateToggle').addEventListener('click', () => {
            isCandidateMode = !isCandidateMode;
            const candidateToggle = document.getElementById('candidateToggle');
            const modeLabel = candidateToggle.querySelector('.mode-toggle-label');
            const modeIcon = candidateToggle.querySelector('.mode-toggle-icon');
            
            if (isCandidateMode) {
                modeLabel.textContent = 'å€™è£œ';
                modeIcon.textContent = 'âœï¸';
                candidateToggle.classList.add('active');
            } else {
                modeLabel.textContent = 'ç¢ºå®š';
                modeIcon.textContent = 'âœ“';
                candidateToggle.classList.remove('active');
            }
        });

        // åˆæœŸåŒ–
        initGrid();
        startNewGame();
    </script>
</body>
</html>
